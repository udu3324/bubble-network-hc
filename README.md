# bubble network

A website that visualizes who you are connected to in slack.

## how it works

Oauth access gives slack endpoints to reveal what **public** channels you are in. It can then be scanned with the most recent 1000 messages. From there, it checks if the message is a thread and if you are the author or have replied in it.

**How is this a Good Metric**    

Its.... good enough. Slack does offer scopes to reveal dmed users, group conversations, or private channels, but the bot itself has to be invited to them to see it. I do not know a workaround to this unless if everyone is willing to invite the bot to their channel, or the bot recieves admin workspace access.

## endpoints
```

# "id" is a query string of "?id=" at the end of a fetch url
# requiring auth passes a slack token and id securely through the request header


/api/render - renders a sharable image of the slack id's bubble


# /api/slack --- ALL ARE FOR INTERNAL USE ONLY!!!
/avatar - proxys an image to avoid cors issue
/cache - caches a slack id
/callback - for slack oauth
/scan - scans a slack id 


# /api/supabase --- Public data
/cache - get the cache of an "id" (query string)
/network - get the network of an "id" (query string)
/clear - clear the network data of an "id" (requires auth)
/ncache - bulk /api/slack/cache of a network's id_list of "id" (requires auth)

```

## database 

I use supabase but any could work. Two tables are needed to store data, one for slack profile data and another for network data.

**cache table**
```sql
create table public.cache (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  slack_id text null,
  username text null,
  profile_picture text null,
  modified_at timestamp with time zone null default now(),
  constraint cache_pkey primary key (id),
  constraint cache_slack_id_key unique (slack_id)
) TABLESPACE pg_default;
```

**network table**
```sql
create table public.network (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  modified_at timestamp with time zone null,
  slack_id text null,
  id_list text[] null,
  id_list_special text[] null,
  constraint network_pkey primary key (id),
  constraint network_slack_id_key unique (slack_id)
) TABLESPACE pg_default;
```

## development

To setup a dev enviornment, make sure you have nodejs installed with npm. Clone it into your favorite IDE and run the commands below!

```
npm install

npm run dev
```

Slack OAuth **DOES NOT WORK** in the dev enviornment as the callback points back to the real domain. I think there's a way to fix this but im too lazy. As a workaround, you can oauth from production and export your localstorage variables and reimport into localhost. 

## environment variables

```

SLACK_WEBHOOK_STATUS=
SLACK_WEBHOOK_LOGS=

SLACK_ORGANIZATION_ID=
SLACK_CLIENT_ID=
SLACK_CLIENT_SECRET=
SLACK_BOT_OAUTH_TOKEN=
PUBLIC_BASE_URL=
PUBLIC_SLACK_APP_CLIENT_ID=

PUBLIC_SUPABASE_URL=
PUBLIC_SUPABASE_ANON_KEY=

SUPABASE_SERVICE_ROLE_KEY=

```